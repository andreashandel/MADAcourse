{
  "hash": "1b5ceb3db449b0780923587118dfc9b7",
  "result": {
    "markdown": "---\ntitle: Scrambling existing data - R\nsubtitle: \"\"\n---\n\n\n\n\n\n# Overview\nIn this tutorial, we discuss how to scramble existing data to make it \"new\".\n\n\n# Learning Objectives\n\n* Be able to generate scrambled data with `R` based on existing data.\n\n\n\n# Introduction\n\nIf you want to be as close to the original data as possible, you can just take that data and scramble values such that observations become new.\n\nLet's say you have individuals with different characteristics such as age, height, gender, BMI, etc. By just randomly re-assigning values for each variable to individuals, you create new individuals. Those individuals are not real and thus you minimize potential problems with confidentiality. \n\nSince you are using exactly the same values for each variable as in the original dataset, the distribution for each variable remains the same and is thus very close (in fact, identical) to the real data.\n\nHowever, a problem with such scrambling is that while you preserve the distribution of each variable, you might break associations. For instance, males are generally taller than females. If you randomly scramble both gender and height without taking into account this potential association, you might end up with a dataset that has a distribution of heights among males and females that is the same. Depending on your goals, this might or might not be a problem.\n\nAnother drawback of scrambling data is that you can't build associations between variables into the data generating process, so you don't really know what your models should find when they look for patterns. Thus, a big advantage of synthetic data, namely the fact that you know exactly how it was generated, goes away. \n\nIn general, I'm not too big a fan of the scrambling approach, but there might be scenarios where this is what you want/need, therefore we should talk about it.\n\n\n\n## AI help \n\nSince you are working with the real data, you probably don't want to use AI for this, unless your AI tool operates in a secure environment (e.g., fully on your companies' servers). \n\n\n## Example\n\nTime for a simple example. You can find the code shown below in [this file](/code/synthetic-data-existing-R-example-code.R).\n\n\n### Setup\n\nFirst, we do the usual setup steps of package loading and other housekeeping steps.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary('dplyr')\nlibrary('ggplot2')\nlibrary('here')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# setting a random number seed for reproducibility\nset.seed(123)\n```\n:::\n\n\n### Data loading and exploring\n\nWe'll look at some real data from [this paper](https://royalsocietypublishing.org/doi/10.1098/rspb.2020.0496). As is good habit (and should be the standard), the authors (which includes some of us) supplied the data as part of the supplementary materials, which can be found [here](https://datadryad.org/stash/dataset/doi:10.5061/dryad.51c59zw4v). \n\nIf you want to work along, go ahead and download the supplement, which is a zip file. Inside the zip file, find the _Clean Data_ folder and the `SympAct_Any_Pos.Rda` file. Copy that file to the location where you'll be placing your `R` script. \n\nFirst, we load the data. Note that the authors (that would be us üòè) used the wrong file ending, they called it an `.Rda` file, even though it is an `.Rds` file (for a discussion of the differences, see e.g. [here](http://www.sthda.com/english/wiki/saving-data-into-r-data-format-rds-and-rdata)).\n\n\n### The data \n\n\n::: {.cell}\n\n```{.r .cell-code}\n#assuming your R script is in the same folder\n#rawdat <- readRDS('SympAct_Any_Pos.Rda')\n# this is for my setup\nrawdat <- readRDS(here::here('data','SympAct_Any_Pos.Rda'))\n```\n:::\n\n\nNext, we take a peek.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndim(rawdat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 735  63\n```\n:::\n\n```{.r .cell-code}\ndplyr::glimpse(rawdat)  \n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 735\nColumns: 63\n$ DxName1           <fct> \"Influenza like illness - Clinical Dx\", \"Acute tonsi‚Ä¶\n$ DxName2           <fct> NA, \"Influenza like illness - Clinical Dx\", \"Acute p‚Ä¶\n$ DxName3           <fct> NA, NA, NA, NA, NA, NA, NA, NA, \"Fever, unspecified\"‚Ä¶\n$ DxName4           <fct> NA, NA, NA, NA, NA, NA, NA, NA, \"Other fatigue\", NA,‚Ä¶\n$ DxName5           <fct> NA, NA, NA, NA, NA, NA, NA, NA, \"Headache\", NA, NA, ‚Ä¶\n$ Unique.Visit      <chr> \"340_17632125\", \"340_17794836\", \"342_17737773\", \"342‚Ä¶\n$ ActivityLevel     <int> 10, 6, 2, 2, 5, 3, 4, 0, 0, 5, 9, 1, 3, 6, 5, 2, 2, ‚Ä¶\n$ ActivityLevelF    <fct> 10, 6, 2, 2, 5, 3, 4, 0, 0, 5, 9, 1, 3, 6, 5, 2, 2, ‚Ä¶\n$ SwollenLymphNodes <fct> Yes, Yes, Yes, Yes, Yes, No, No, No, Yes, No, Yes, Y‚Ä¶\n$ ChestCongestion   <fct> No, Yes, Yes, Yes, No, No, No, Yes, Yes, Yes, Yes, Y‚Ä¶\n$ ChillsSweats      <fct> No, No, Yes, Yes, Yes, Yes, Yes, Yes, Yes, No, Yes, ‚Ä¶\n$ NasalCongestion   <fct> No, Yes, Yes, Yes, No, No, No, Yes, Yes, Yes, Yes, Y‚Ä¶\n$ CoughYN           <fct> Yes, Yes, No, Yes, No, Yes, Yes, Yes, Yes, Yes, No, ‚Ä¶\n$ Sneeze            <fct> No, No, Yes, Yes, No, Yes, No, Yes, No, No, No, No, ‚Ä¶\n$ Fatigue           <fct> Yes, Yes, Yes, Yes, Yes, Yes, Yes, Yes, Yes, Yes, Ye‚Ä¶\n$ SubjectiveFever   <fct> Yes, Yes, Yes, Yes, Yes, Yes, Yes, Yes, Yes, No, Yes‚Ä¶\n$ Headache          <fct> Yes, Yes, Yes, Yes, Yes, Yes, No, Yes, Yes, Yes, Yes‚Ä¶\n$ Weakness          <fct> Mild, Severe, Severe, Severe, Moderate, Moderate, Mi‚Ä¶\n$ WeaknessYN        <fct> Yes, Yes, Yes, Yes, Yes, Yes, Yes, Yes, Yes, Yes, Ye‚Ä¶\n$ CoughIntensity    <fct> Severe, Severe, Mild, Moderate, None, Moderate, Seve‚Ä¶\n$ CoughYN2          <fct> Yes, Yes, Yes, Yes, No, Yes, Yes, Yes, Yes, Yes, Yes‚Ä¶\n$ Myalgia           <fct> Mild, Severe, Severe, Severe, Mild, Moderate, Mild, ‚Ä¶\n$ MyalgiaYN         <fct> Yes, Yes, Yes, Yes, Yes, Yes, Yes, Yes, Yes, Yes, Ye‚Ä¶\n$ RunnyNose         <fct> No, No, Yes, Yes, No, No, Yes, Yes, Yes, Yes, No, No‚Ä¶\n$ AbPain            <fct> No, No, Yes, No, No, No, No, No, No, No, Yes, Yes, N‚Ä¶\n$ ChestPain         <fct> No, No, Yes, No, No, Yes, Yes, No, No, No, No, Yes, ‚Ä¶\n$ Diarrhea          <fct> No, No, No, No, No, Yes, No, No, No, No, No, No, No,‚Ä¶\n$ EyePn             <fct> No, No, No, No, Yes, No, No, No, No, No, Yes, No, Ye‚Ä¶\n$ Insomnia          <fct> No, No, Yes, Yes, Yes, No, No, Yes, Yes, Yes, Yes, Y‚Ä¶\n$ ItchyEye          <fct> No, No, No, No, No, No, No, No, No, No, No, No, Yes,‚Ä¶\n$ Nausea            <fct> No, No, Yes, Yes, Yes, Yes, No, No, Yes, Yes, Yes, Y‚Ä¶\n$ EarPn             <fct> No, Yes, No, Yes, No, No, No, No, No, No, No, Yes, Y‚Ä¶\n$ Hearing           <fct> No, Yes, No, No, No, No, No, No, No, No, No, No, No,‚Ä¶\n$ Pharyngitis       <fct> Yes, Yes, Yes, Yes, Yes, Yes, Yes, No, No, No, Yes, ‚Ä¶\n$ Breathless        <fct> No, No, Yes, No, No, Yes, No, No, No, Yes, No, Yes, ‚Ä¶\n$ ToothPn           <fct> No, No, Yes, No, No, No, No, No, Yes, No, No, Yes, N‚Ä¶\n$ Vision            <fct> No, No, No, No, No, No, No, No, No, No, No, No, No, ‚Ä¶\n$ Vomit             <fct> No, No, No, No, No, No, Yes, No, No, No, Yes, Yes, N‚Ä¶\n$ Wheeze            <fct> No, No, No, Yes, No, Yes, No, No, No, No, No, Yes, N‚Ä¶\n$ BodyTemp          <dbl> 98.3, 100.4, 100.8, 98.8, 100.5, 98.4, 102.5, 98.4, ‚Ä¶\n$ RapidFluA         <fct> Presumptive Negative For Influenza A, NA, Presumptiv‚Ä¶\n$ RapidFluB         <fct> Presumptive Negative For Influenza B, NA, Presumptiv‚Ä¶\n$ PCRFluA           <fct> NA, NA, NA, NA, NA, NA,  Influenza A Not Detected, N‚Ä¶\n$ PCRFluB           <fct> NA, NA, NA, NA, NA, NA,  Influenza B Not Detected, N‚Ä¶\n$ TransScore1       <dbl> 1, 3, 4, 5, 0, 2, 2, 5, 4, 4, 2, 3, 2, 5, 3, 5, 1, 5‚Ä¶\n$ TransScore1F      <fct> 1, 3, 4, 5, 0, 2, 2, 5, 4, 4, 2, 3, 2, 5, 3, 5, 1, 5‚Ä¶\n$ TransScore2       <dbl> 1, 2, 3, 4, 0, 2, 2, 4, 3, 3, 1, 2, 2, 4, 2, 4, 1, 4‚Ä¶\n$ TransScore2F      <fct> 1, 2, 3, 4, 0, 2, 2, 4, 3, 3, 1, 2, 2, 4, 2, 4, 1, 4‚Ä¶\n$ TransScore3       <dbl> 1, 1, 2, 3, 0, 2, 2, 3, 2, 2, 0, 1, 1, 3, 1, 3, 1, 3‚Ä¶\n$ TransScore3F      <fct> 1, 1, 2, 3, 0, 2, 2, 3, 2, 2, 0, 1, 1, 3, 1, 3, 1, 3‚Ä¶\n$ TransScore4       <dbl> 0, 2, 4, 4, 0, 1, 1, 4, 3, 3, 2, 2, 2, 4, 3, 4, 0, 4‚Ä¶\n$ TransScore4F      <fct> 0, 2, 4, 4, 0, 1, 1, 4, 3, 3, 2, 2, 2, 4, 3, 4, 0, 4‚Ä¶\n$ ImpactScore       <int> 7, 8, 14, 12, 11, 12, 8, 7, 10, 7, 13, 17, 11, 13, 9‚Ä¶\n$ ImpactScore2      <int> 6, 7, 13, 11, 10, 11, 7, 6, 9, 6, 12, 16, 10, 12, 8,‚Ä¶\n$ ImpactScore3      <int> 3, 4, 9, 7, 6, 7, 3, 3, 6, 4, 7, 11, 6, 8, 4, 4, 5, ‚Ä¶\n$ ImpactScoreF      <fct> 7, 8, 14, 12, 11, 12, 8, 7, 10, 7, 13, 17, 11, 13, 9‚Ä¶\n$ ImpactScore2F     <fct> 6, 7, 13, 11, 10, 11, 7, 6, 9, 6, 12, 16, 10, 12, 8,‚Ä¶\n$ ImpactScore3F     <fct> 3, 4, 9, 7, 6, 7, 3, 3, 6, 4, 7, 11, 6, 8, 4, 4, 5, ‚Ä¶\n$ ImpactScoreFD     <fct> 7, 8, 14, 12, 11, 12, 8, 7, 10, 7, 13, 17, 11, 13, 9‚Ä¶\n$ TotalSymp1        <dbl> 8, 11, 18, 17, 11, 14, 10, 12, 14, 11, 15, 20, 13, 1‚Ä¶\n$ TotalSymp1F       <fct> 8, 11, 18, 17, 11, 14, 10, 12, 14, 11, 15, 20, 13, 1‚Ä¶\n$ TotalSymp2        <dbl> 8, 10, 17, 16, 11, 14, 10, 11, 13, 10, 14, 19, 13, 1‚Ä¶\n$ TotalSymp3        <dbl> 8, 9, 16, 15, 11, 14, 10, 10, 12, 9, 13, 18, 12, 16,‚Ä¶\n```\n:::\n:::\n\n\nSo it looks like these are 735 individuals (rows) and 63 variables (columns). A lot of them have names of symptoms and are coded as Yes/No. Some variables are harder to  understand, for instance without some meta-data/explanation, it is impossible to guess what `TransScore3F` stands for. Hopefully, your data came with some codebook/data dictionary/information sheet that explains what exactly everything means. For this specific data set, you can look through the supplementary materials to learn more. We won't delve into it now, and just pick out a few variables to illustrate the data scrambling process.\n\n\n### Data processing\n\nFor simplicity, let's assume we are interested in just a few of these variables, namely `ActivityLevel`, `Sneeze`, `Nausea`, and `Vomit`. We'll select those and look at the first 10 entries.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- rawdat |> dplyr::select(\"ActivityLevel\",\"Sneeze\",\"Nausea\",\"Vomit\")\nhead(dat,10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   ActivityLevel Sneeze Nausea Vomit\n1             10     No     No    No\n2              6     No     No    No\n3              2    Yes    Yes    No\n4              2    Yes    Yes    No\n5              5     No    Yes    No\n6              3    Yes    Yes    No\n7              4     No     No   Yes\n8              0    Yes     No    No\n9              0     No    Yes    No\n10             5     No    Yes    No\n```\n:::\n:::\n\n\n\n### Data Scrambling\n\nNow we'll scramble the data. I'm doing this here with a simple loop. I'm looping through each variable, and I sample from the old values without replacement, which basically just rearranges them. There are computationally faster and more concise ways of doing this, but the loop makes it hopefully very clear what's going on.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# define a new data frame that will contain scrambled values\ndat_sc <- dat\nNobs = nrow(dat) #number of observations\n# loop over each variable, reshuffle entries\nfor (n in 1:ncol(dat))\n{\n  dat_sc[,n] <- sample(dat[,n], size = Nobs, replace = FALSE)\n}\n\nhead(dat_sc,10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   ActivityLevel Sneeze Nausea Vomit\n1              5     No     No    No\n2              0     No     No    No\n3              3    Yes     No    No\n4              5     No    Yes    No\n5              5     No    Yes    No\n6              1    Yes     No    No\n7              3    Yes     No    No\n8              8    Yes     No    No\n9              6    Yes     No    No\n10             4    Yes    Yes    No\n```\n:::\n:::\n\n\nThe first 10 entries look different, so that's promising.\n\n### Comparing old and new data \n\nNow let's see if things worked. First, we summarize both the old and the new data. We should see that they are the same, since we just re-arranged the values across individuals. This is indeed the case.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n ActivityLevel    Sneeze    Nausea    Vomit    \n Min.   : 0.000   No :340   No :477   No :656  \n 1st Qu.: 3.000   Yes:395   Yes:258   Yes: 79  \n Median : 4.000                                \n Mean   : 4.463                                \n 3rd Qu.: 6.000                                \n Max.   :10.000                                \n```\n:::\n\n```{.r .cell-code}\nsummary(dat_sc)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n ActivityLevel    Sneeze    Nausea    Vomit    \n Min.   : 0.000   No :340   No :477   No :656  \n 1st Qu.: 3.000   Yes:395   Yes:258   Yes: 79  \n Median : 4.000                                \n Mean   : 4.463                                \n 3rd Qu.: 6.000                                \n Max.   :10.000                                \n```\n:::\n:::\n\n\n\nWe can also look at correlations between variables. Here is where we run into the above-mentioned problems. Correlations that might exist in the original data can be wiped out. We see that here. In the original data, more individuals (approximately 63% + 9%) reported either absence or presence of both nausea and vomiting. In the scrambled data, this dropped to around 58% + 4%. We would expect that these 2 symptoms are somewhat related, and the scrambling removed it. Similarily, the original data showed lower activity levels for those with vomit as symptom. This pattern is gone in the scrambled data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# cross-tabulation of 2 symptoms\ntb1=table(dat$Nausea,dat$Vomit)\nprop.table(tb1)*100 #as percentage\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     \n             No       Yes\n  No  62.993197  1.904762\n  Yes 26.258503  8.843537\n```\n:::\n\n```{.r .cell-code}\ntb2=table(dat_sc$Nausea,dat_sc$Vomit)\nprop.table(tb2)*100\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     \n             No       Yes\n  No  58.095238  6.802721\n  Yes 31.156463  3.945578\n```\n:::\n\n```{.r .cell-code}\n# looking at possible correlation between activity level and Vomit\np1 <- dat |> ggplot(aes(x=Vomit,y=ActivityLevel)) + geom_boxplot()\nplot(p1)\n```\n\n::: {.cell-output-display}\n![](synthetic-data-existing-r_files/figure-html/compare-data2-1.png){width=672}\n:::\n\n```{.r .cell-code}\np2 <- dat_sc |> ggplot(aes(x=Vomit,y=ActivityLevel)) + geom_boxplot()\nplot(p2)\n```\n\n::: {.cell-output-display}\n![](synthetic-data-existing-r_files/figure-html/compare-data2-2.png){width=672}\n:::\n:::\n\n\n\nThat means any statistical conclusions based on the scrambled data are not valid. This kind of data is just useful at testing the overall workflow and making sure everything can run, but one can't conclude anything from it.\n\nIt is of course possible to try to scramble while preserving potential correlations, but that gets tricky and at this stage one might maybe just re-create the data based on some of the concepts discussed in the previous unit.\n\n# Summary\n\nScrambling the original data is generally fairly easy. It can be useful to for sharing with others or some AI system with reduced issues of confidentiality. One can use it to test if the whole analysis workflow runs. However, one cannot test methods since one doesn't know what patterns the models should detect, and any statistical conclusions based on the scrambled data are not very meaningful.\n\n\n# Further Resources\n\nThe [synthpop R package](https://www.synthpop.org.uk/index.html) might be useful. It doesn't quite preserve the original data, it's more similar to the approach discussed in the unit [Generating synthetic data based on existing data](../synthetic-data-new-existing-r/synthetic-data-new-existing-r.qmd). But you can get data that is very close to the original, thus might often give you what you wanted to get when you considered the scrambling approach.\n\n\n\n\n\n",
    "supporting": [
      "synthetic-data-existing-r_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}